# 认证

## 需求

### 核心功能

- 验证码机制
  - 支持短信/邮件/图形验证码（可配置）
  - 默认开启验证码功能
  - 关闭验证码需进行风险提示（需记录操作日志并二次确认）
- 认证方式：
  - 基础认证：用户名 + 密码
  - 增强认证：用户名 + 密码 + TOTP（时间型动态令牌）
  - 生物特征认证，考虑支持webauthn对接苹果touchid
  - 第三方认证：OAuth2.0/OpenID Connect（未来扩展）

### 接口规范

- 必须实现接口：
  - `/auth/login`（登录认证）
  - `/auth/logout`（会话终止）
  - `/auth/refresh`（令牌刷新）
  - `/auth/lock-status`（账户锁定状态查询）
- 接口要求：
  - 遵循RESTful规范
  - 请求/响应加密（HTTPS + 敏感字段单独加密）
  - 版本控制（/v1/auth/...）

### 测试要求

- 单元测试覆盖率 ≥80%
- 集成测试包含：
  - 正常流测试（成功案例）
  - 异常流测试（错误凭证、锁定状态等）
  - 安全测试（重放攻击、暴力破解防护）
  - 性能测试（支持≥1000并发认证请求）

## 安全设计

### 会话管理

- 采用JWT + Refresh Token双令牌机制
- 令牌生命周期：
  - Access Token：15分钟
  - Refresh Token：7天（单次使用）
- 认证成功后必须更换会话标识

### 防护机制

- 暴力破解防护：
  - 连续n次失败锁定账户，次数可配置，默认5次
  - 自动解锁时间：可配置，默认30分钟
  - 管理员可手动解锁
- 密码策略：
  - 最小长度8位
  - 需包含大小写字母+数字+特定特殊字符
  - 最长90天强制更换
- 传输加密：
  - TLS 1.2+ 强制启用
  - 敏感字段（密码）使用AES-256二次加密

### 日志规范

- 记录事件：
  - 认证成功/失败
  - 账户锁定/解锁
  - 令牌刷新
  - 验证码操作
- 日志字段：
  ```ts
  {
    timestamp: Date
    userId?: string
    eventType: 'AUTH_SUCCESS' | 'AUTH_FAIL' | ... 
    clientIP: string
    userAgent: string
    riskLevel: 'LOW' | 'MEDIUM' | 'HIGH'
    metadata: Record<string, any> // 附加信息
  }
  ```

## 非功能需求

1. 性能要求：95%的认证请求响应时间 < 500ms
2. 审计要求：操作日志保留≥180天
3. 兼容性：支持Chrome/Firefox/Safari最新3个版本
